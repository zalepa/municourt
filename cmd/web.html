<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Municipal Court Statistics</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root {
    /* Typographic scale — 1.25 ratio */
    --text-xs: 0.6875rem;
    --text-sm: 0.8125rem;
    --text-base: 1rem;
    --text-lg: 1.25rem;
    --text-xl: 1.5rem;

    /* Spatial scale — base 8 */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-6: 1.5rem;
    --space-8: 2rem;
    --space-12: 3rem;
    --space-16: 4rem;

    /* Neutral scale — warm gray */
    --gray-50: #fafaf9;
    --gray-100: #f5f5f4;
    --gray-200: #e7e5e4;
    --gray-300: #d6d3d1;
    --gray-400: #a8a29e;
    --gray-500: #78716c;
    --gray-600: #57534e;
    --gray-700: #44403c;
    --gray-800: #292524;
    --gray-900: #1c1917;

    /* Surfaces */
    --bg: #ffffff;
    --border: var(--gray-200);

    /* Motion */
    --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    --duration-fast: 120ms;
    --duration-normal: 200ms;

    /* Depth */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
    --radius: 6px;
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    background: var(--bg);
    color: var(--gray-900);
    -webkit-font-smoothing: antialiased;
    line-height: 1.5;
  }

  .page { display: flex; flex-direction: column; min-height: 100vh; }

  /* ── Header ── */
  header {
    padding: var(--space-6) var(--space-8) var(--space-4);
    display: flex;
    align-items: baseline;
    justify-content: space-between;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  h1 {
    font-size: var(--text-xl);
    font-weight: 600;
    letter-spacing: -0.025em;
    color: var(--gray-900);
  }

  .info-btn {
    width: 18px; height: 18px;
    border-radius: 50%;
    border: 1.5px solid var(--gray-400);
    background: none; cursor: pointer;
    font-size: 11px; font-style: italic;
    font-family: Georgia, serif;
    color: var(--gray-400);
    display: inline-flex; align-items: center; justify-content: center;
    padding: 0; flex-shrink: 0;
    transition: border-color var(--duration-fast) var(--ease-out),
                color var(--duration-fast) var(--ease-out);
  }
  .info-btn:hover { border-color: var(--gray-900); color: var(--gray-900); }
  .info-btn:focus-visible {
    outline: 2px solid var(--gray-900);
    outline-offset: 2px;
  }

  .header-right {
    display: flex; align-items: center; gap: var(--space-1);
  }

  .icon-btn {
    background: none; border: none; cursor: pointer;
    color: var(--gray-400); padding: var(--space-2);
    border-radius: var(--radius);
    display: inline-flex; align-items: center;
    transition: color var(--duration-fast) var(--ease-out);
  }
  .icon-btn:hover { color: var(--gray-900); }
  .icon-btn:focus-visible {
    outline: 2px solid var(--gray-900);
    outline-offset: 2px;
  }
  .icon-btn svg { width: 18px; height: 18px; }

  /* ── Controls ── */
  .controls {
    padding: 0 var(--space-8) var(--space-4);
    display: flex; align-items: flex-end;
    gap: var(--space-3);
    flex-wrap: wrap;
  }

  .control-group {
    display: flex; flex-direction: column; gap: var(--space-1);
  }

  .control-group label {
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .control-group select {
    appearance: none; -webkit-appearance: none;
    padding: 7px var(--space-8) 7px var(--space-3);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    font-size: var(--text-sm);
    font-family: inherit;
    color: var(--gray-900);
    background: var(--bg)
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath d='M2.5 4l2.5 2.5L7.5 4' fill='none' stroke='%23a8a29e' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")
      no-repeat right 10px center;
    cursor: pointer;
    transition: border-color var(--duration-fast) var(--ease-out);
  }
  .control-group select:hover { border-color: var(--gray-500); }
  .control-group select:focus-visible {
    outline: none;
    border-color: var(--gray-900);
  }

  .controls .divider {
    width: 1px; height: 28px;
    background: var(--gray-200);
    align-self: flex-end;
    margin-bottom: 6px;
  }

  .add-btn {
    padding: 7px var(--space-4);
    border: 1px solid var(--gray-900);
    border-radius: var(--radius);
    background: var(--gray-900); color: #fff;
    font-size: var(--text-sm); font-weight: 500;
    font-family: inherit; cursor: pointer;
    transition: background var(--duration-fast) var(--ease-out);
  }
  .add-btn:hover { background: var(--gray-700); border-color: var(--gray-700); }
  .add-btn:focus-visible {
    outline: 2px solid var(--gray-900);
    outline-offset: 2px;
  }

  .hidden { display: none !important; }

  /* ── Chips ── */
  .chips-bar {
    display: flex; flex-wrap: wrap;
    gap: var(--space-2);
    padding: 0 var(--space-8) var(--space-3);
    align-items: center;
  }
  .chips-bar:empty { display: none; }

  .chip {
    display: inline-flex; align-items: center; gap: 2px;
    padding: 3px var(--space-3);
    border-radius: 999px;
    font-size: var(--text-xs); font-weight: 500;
    color: var(--gray-700);
    background: var(--gray-100);
    transition: background var(--duration-fast) var(--ease-out);
  }

  .chip .remove {
    cursor: pointer; font-size: 13px; line-height: 1;
    opacity: 0.35; font-weight: 600;
    margin-left: 2px;
    transition: opacity var(--duration-fast) var(--ease-out);
  }
  .chip .remove:hover { opacity: 1; }

  .clear-btn {
    background: none; border: none;
    color: var(--gray-400); cursor: pointer;
    padding: 3px var(--space-2);
    font-size: var(--text-xs); font-weight: 500;
    font-family: inherit;
    margin-left: auto;
    transition: color var(--duration-fast) var(--ease-out);
  }
  .clear-btn:hover { color: var(--gray-900); }

  /* ── Chart ── */
  .chart-wrap { flex: 1; padding: 0 var(--space-8) var(--space-4); }
  #chart { width: 100%; height: calc(100vh - 210px); min-height: 300px; }

  /* ── Footer ── */
  footer {
    padding: var(--space-3) var(--space-8) var(--space-6);
    text-align: center;
    font-size: var(--text-xs); color: var(--gray-400);
  }
  footer a {
    color: var(--gray-400); text-decoration: none;
    transition: color var(--duration-fast) var(--ease-out);
  }
  footer a:hover { color: var(--gray-900); }

  /* ── Modal ── */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(28,25,23,0.2);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    z-index: 1000;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg);
    border-radius: calc(var(--radius) * 2);
    max-width: 440px; width: 88%;
    padding: var(--space-8);
    position: relative;
    box-shadow: var(--shadow-lg);
    max-height: 90vh; overflow-y: auto;
  }
  .modal h2 {
    font-size: var(--text-lg); font-weight: 600;
    letter-spacing: -0.02em;
    margin-bottom: var(--space-4);
  }
  .modal p {
    font-size: var(--text-sm); line-height: 1.65;
    color: var(--gray-600); margin-bottom: var(--space-3);
  }
  .modal p:last-of-type { margin-bottom: 0; }
  .modal a {
    color: var(--gray-900);
    text-decoration: underline;
    text-underline-offset: 2px;
    text-decoration-color: var(--gray-300);
    transition: text-decoration-color var(--duration-fast) var(--ease-out);
  }
  .modal a:hover { text-decoration-color: var(--gray-900); }
  .modal-close {
    position: absolute; top: var(--space-4); right: var(--space-4);
    background: none; border: none;
    font-size: 18px; cursor: pointer;
    color: var(--gray-400); line-height: 1; padding: var(--space-1);
    transition: color var(--duration-fast) var(--ease-out);
  }
  .modal-close:hover { color: var(--gray-900); }

  /* ── Table modal ── */
  .modal--wide { max-width: 90vw; width: 90vw; }

  .modal-header {
    display: flex; align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-4);
  }
  .modal-header h2 { margin-bottom: 0; }

  .csv-btn {
    padding: 5px var(--space-3);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    background: var(--bg); color: var(--gray-700);
    font-size: var(--text-xs); font-weight: 500;
    font-family: inherit; cursor: pointer;
    display: inline-flex; align-items: center; gap: var(--space-1);
    transition: border-color var(--duration-fast) var(--ease-out),
                color var(--duration-fast) var(--ease-out);
  }
  .csv-btn:hover { border-color: var(--gray-900); color: var(--gray-900); }
  .csv-btn svg { width: 14px; height: 14px; }

  .table-wrap {
    overflow: auto;
    max-height: calc(90vh - 100px);
  }

  .data-table {
    width: 100%; border-collapse: collapse;
    font-size: var(--text-xs);
    font-variant-numeric: tabular-nums;
  }
  .data-table th, .data-table td {
    padding: var(--space-1) var(--space-3);
    text-align: right;
    white-space: nowrap;
    border-bottom: 1px solid var(--gray-100);
  }
  .data-table th {
    position: sticky; top: 0;
    background: var(--bg);
    font-weight: 600; color: var(--gray-600);
    border-bottom-color: var(--gray-200);
  }
  .data-table th:first-child,
  .data-table td:first-child {
    text-align: left;
    position: sticky; left: 0;
    background: var(--bg);
  }
  .data-table tbody tr:hover td { background: var(--gray-50); }
  .data-table tbody tr:hover td:first-child { background: var(--gray-50); }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    header { padding: var(--space-4) var(--space-4) var(--space-3); }
    h1 { font-size: var(--text-lg); }
    .controls { padding: 0 var(--space-4) var(--space-3); gap: var(--space-2); }
    .control-group { flex: 1; min-width: 0; }
    .control-group select { width: 100%; }
    .controls .divider { display: none; }
    .chips-bar { padding: 0 var(--space-4) var(--space-3); }
    .chart-wrap { padding: 0 var(--space-4) var(--space-3); }
    #chart { height: calc(100vh - 240px); }
    footer { padding: var(--space-3) var(--space-4) var(--space-4); }
    .modal { padding: var(--space-6); }
  }

  @media (max-width: 480px) {
    .controls { gap: var(--space-2); }
    .control-group { flex-basis: calc(50% - var(--space-1)); }
    #chart { height: calc(100vh - 280px); }
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after { transition-duration: 0.01ms !important; }
  }
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F1WJYLL3B3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F1WJYLL3B3');
</script>
<body>

<div class="page">
  <header>
    <div class="header-left">
      <h1>Municipal Court Statistics</h1>
      <button class="info-btn" id="info-btn" title="About" aria-label="About this site">i</button>
    </div>
    <div class="header-right">
      <button class="icon-btn" id="table-btn" title="View data table" aria-label="View data table">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
      </button>
      <button class="icon-btn" id="download-btn" title="Save as image" aria-label="Download chart as image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </button>
    </div>
  </header>

  <div class="controls">
    <div class="control-group">
      <label for="metric">Metric</label>
      <select id="metric"></select>
    </div>
    <div class="control-group">
      <label for="type">Case Type</label>
      <select id="type"></select>
    </div>
    <div class="divider"></div>
    <div class="control-group">
      <label for="add-level">Level</label>
      <select id="add-level">
        <option value="state">State</option>
        <option value="county">County</option>
        <option value="municipality">Municipality</option>
      </select>
    </div>
    <div class="control-group hidden" id="add-county-group">
      <label for="add-county">County</label>
      <select id="add-county"></select>
    </div>
    <div class="control-group hidden" id="add-muni-group">
      <label for="add-muni">Municipality</label>
      <select id="add-muni"></select>
    </div>
    <button class="add-btn" id="add-btn">Add</button>
  </div>

  <div class="chips-bar" id="chips"></div>

  <div class="chart-wrap">
    <div id="chart"></div>
  </div>

  <footer>
    <a href="https://github.com/hackJerseyCity/municourt" target="_blank" rel="noopener noreferrer">github.com/hackJerseyCity/municourt</a>
  </footer>
</div>

<div class="modal-overlay" id="info-modal">
  <div class="modal">
    <button class="modal-close" id="modal-close" aria-label="Close">&times;</button>
    <h2>About</h2>
    <p>
      Visualizes New Jersey municipal court statistics over time.
      Data is sourced from NJ Courts public reports, covering filings,
      resolutions, clearance rates, and case backlog across all
      municipalities and counties.
    </p>
    <p>
      Select a metric and case type, then add entities at the state,
      county, or municipality level to compare trends.
    </p>
    <p>
      Built by <a href="https://github.com/hackJerseyCity" target="_blank" rel="noopener noreferrer">Hack Jersey City</a>.
      Source on <a href="https://github.com/hackJerseyCity/municourt" target="_blank" rel="noopener noreferrer">GitHub</a>.
    </p>
  </div>
</div>

<div class="modal-overlay" id="table-modal">
  <div class="modal modal--wide">
    <button class="modal-close" id="table-modal-close" aria-label="Close">&times;</button>
    <div class="modal-header">
      <h2>Data Table</h2>
      <button class="csv-btn" id="csv-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download CSV
      </button>
    </div>
    <div class="table-wrap" id="table-wrap"></div>
  </div>
</div>

<script>
/* ── Chart palette — restrained, distinguishable ── */
const palette = [
  '#2563eb', // Blue        (hue ≈220°)
  '#ea580c', // Orange      (hue ≈ 25°)
  '#16a34a', // Green       (hue ≈142°)
  '#dc2626', // Red         (hue ≈  0°)
  '#9333ea', // Purple      (hue ≈270°)
  '#0891b2', // Cyan        (hue ≈190°)
  '#ca8a04', // Gold        (hue ≈ 45°)
  '#c026d3', // Fuchsia     (hue ≈300°)
  '#65a30d', // Lime        (hue ≈ 85°)
  '#475569', // Slate       (neutral anchor)
];

const chart = echarts.init(document.getElementById('chart'));
window.addEventListener('resize', () => chart.resize());

let meta = null;
let entities = [];
let lastRenderData = null;

const selMetric = document.getElementById('metric');
const selType = document.getElementById('type');
const selAddLevel = document.getElementById('add-level');
const selAddCounty = document.getElementById('add-county');
const selAddMuni = document.getElementById('add-muni');
const addCountyGroup = document.getElementById('add-county-group');
const addMuniGroup = document.getElementById('add-muni-group');
const addBtn = document.getElementById('add-btn');
const chipsEl = document.getElementById('chips');
const downloadBtn = document.getElementById('download-btn');
const tableBtn = document.getElementById('table-btn');
const tableModal = document.getElementById('table-modal');
const tableModalClose = document.getElementById('table-modal-close');
const tableWrap = document.getElementById('table-wrap');
const csvBtn = document.getElementById('csv-btn');
const infoBtn = document.getElementById('info-btn');
const infoModal = document.getElementById('info-modal');
const modalClose = document.getElementById('modal-close');

function populateSelect(sel, options) {
  sel.innerHTML = '';
  for (const opt of options) {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    sel.appendChild(o);
  }
}

function updateAdderVisibility() {
  const level = selAddLevel.value;
  if (level === 'state') {
    addCountyGroup.classList.add('hidden');
    addMuniGroup.classList.add('hidden');
  } else if (level === 'county') {
    addCountyGroup.classList.remove('hidden');
    addMuniGroup.classList.add('hidden');
    populateAddCounty(true);
  } else {
    addCountyGroup.classList.remove('hidden');
    addMuniGroup.classList.remove('hidden');
    populateAddCounty(false);
    updateAddMunicipalities();
  }
}

function populateAddCounty(includeAll) {
  const opts = [];
  if (includeAll) opts.push({ value: '__all__', label: 'All Counties' });
  for (const c of meta.counties) opts.push({ value: c, label: c });
  populateSelect(selAddCounty, opts);
}

function updateAddMunicipalities() {
  const county = selAddCounty.value;
  const munis = (county && meta.municipalities[county]) || [];
  const opts = [{ value: '__all__', label: 'All Municipalities' }];
  for (const m of munis) opts.push({ value: m, label: m });
  populateSelect(selAddMuni, opts);
}

function entityKey(level, county, municipality, metric, type) {
  if (level === 'state') return 'state:::' + metric + ':' + type;
  if (level === 'county') return 'county:' + county + '::' + metric + ':' + type;
  return 'municipality:' + county + ':' + municipality + ':' + metric + ':' + type;
}

function entityLabel(level, county, municipality) {
  if (level === 'state') return 'STATEWIDE';
  if (level === 'county') return county;
  return municipality + ' (' + county + ')';
}

function addEntity(level, county, municipality, metric, type) {
  const key = entityKey(level, county, municipality, metric, type);
  if (entities.some(e => e.key === key)) return;
  const label = entityLabel(level, county, municipality);
  entities.push({ level, county: county || '', municipality: municipality || '', metric, type, label, key });
  renderChips();
  fetchAndRender();
}

function removeEntity(key) {
  entities = entities.filter(e => e.key !== key);
  renderChips();
  fetchAndRender();
}

function clearAll() {
  entities = [];
  renderChips();
  fetchAndRender();
}

function updateURL() {
  const params = new URLSearchParams();
  for (const e of entities) params.append('e', e.key);
  history.replaceState(null, '', '?' + params.toString());
}

function loadFromURL() {
  const params = new URLSearchParams(window.location.search);
  const keys = params.getAll('e');

  // Backwards compat: old format stored global metric/type params with 3-part keys
  const globalMetric = params.get('metric') || selMetric.value;
  const globalType = params.get('type') || selType.value;

  if (keys.length > 0) {
    for (const key of keys) {
      const parts = key.split(':');
      const level = parts[0];
      if (!level) continue;
      const county = parts[1] || '';
      const municipality = parts[2] || '';
      // New format: 5 parts; old format: 3 parts (use global defaults)
      const metric = parts[3] || globalMetric;
      const type = parts[4] || globalType;
      const fullKey = entityKey(level, county, municipality, metric, type);
      const label = entityLabel(level, county, municipality);
      if (!entities.some(e => e.key === fullKey)) {
        entities.push({ level, county, municipality, metric, type, label, key: fullKey });
      }
    }
    // Set dropdowns to last entity's metric/type for next-add convenience
    if (entities.length > 0) {
      selMetric.value = entities[entities.length - 1].metric;
      selType.value = entities[entities.length - 1].type;
    }
    renderChips();
    fetchAndRender();
  } else {
    addEntity('state', '', '', selMetric.value, selType.value);
  }
}

function renderChips() {
  chipsEl.innerHTML = '';
  const metrics = new Set(entities.map(e => e.metric));
  const types = new Set(entities.map(e => e.type));
  const showMetric = metrics.size > 1;
  const showType = types.size > 1;
  for (const e of entities) {
    const chip = document.createElement('span');
    chip.className = 'chip';
    let chipLabel = e.label;
    const parts = [];
    if (showMetric) parts.push(metricLabel(e.metric));
    if (showType) parts.push(typeLabel(e.type));
    if (parts.length) chipLabel += ' \u00b7 ' + parts.join(' \u00b7 ');
    chip.innerHTML = '<span class="label"></span><span class="remove" data-key="' +
      e.key.replace(/"/g, '&quot;') + '">\u00d7</span>';
    chip.querySelector('.label').textContent = chipLabel;
    chipsEl.appendChild(chip);
  }
  if (entities.length > 0) {
    const btn = document.createElement('button');
    btn.className = 'clear-btn';
    btn.textContent = 'Clear All';
    btn.addEventListener('click', clearAll);
    chipsEl.appendChild(btn);
  }
}

chipsEl.addEventListener('click', (ev) => {
  const removeBtn = ev.target.closest('.remove');
  if (removeBtn) removeEntity(removeBtn.dataset.key);
});

function handleAdd() {
  const level = selAddLevel.value;
  const metric = selMetric.value;
  const type = selType.value;
  if (level === 'state') {
    addEntity('state', '', '', metric, type);
  } else if (level === 'county') {
    if (selAddCounty.value === '__all__') {
      for (const c of meta.counties) addEntity('county', c, '', metric, type);
    } else {
      addEntity('county', selAddCounty.value, '', metric, type);
    }
  } else {
    const county = selAddCounty.value;
    if (selAddMuni.value === '__all__') {
      const munis = meta.municipalities[county] || [];
      for (const m of munis) addEntity('municipality', county, m, metric, type);
    } else {
      addEntity('municipality', county, selAddMuni.value, metric, type);
    }
  }
}

async function fetchAndRender() {
  if (entities.length === 0) {
    chart.setOption({
      title: {
        text: 'Add an entity to begin',
        left: 'center', top: '40%',
        textStyle: { fontSize: 14, fontWeight: 400, color: '#a8a29e',
          fontFamily: '-apple-system, BlinkMacSystemFont, system-ui, sans-serif' }
      },
      xAxis: { show: false }, yAxis: { show: false }, series: [],
    }, true);
    lastRenderData = null;
    updateURL();
    return;
  }

  const metrics = new Set(entities.map(e => e.metric));
  const types = new Set(entities.map(e => e.type));
  const showMetric = metrics.size > 1;
  const showType = types.size > 1;

  const fetches = entities.map(e => {
    const params = new URLSearchParams({
      level: e.level, metric: e.metric, type: e.type,
      county: e.county, municipality: e.municipality,
    });
    return fetch('/api/series?' + params).then(r => r.json());
  });

  let results;
  try {
    results = await Promise.all(fetches);
  } catch (err) {
    console.error('fetch error', err);
    return;
  }

  const dateSet = new Set();
  for (const r of results) for (const d of r.dates) dateSet.add(d);
  const mergedDates = Array.from(dateSet).sort();

  const dateIndex = new Map();
  mergedDates.forEach((d, i) => dateIndex.set(d, i));

  const allSeries = [];
  for (let i = 0; i < results.length; i++) {
    const r = results[i];
    const e = entities[i];
    for (const s of r.series) {
      const values = new Array(mergedDates.length).fill(null);
      for (let j = 0; j < r.dates.length; j++) {
        const idx = dateIndex.get(r.dates[j]);
        if (idx !== undefined) values[idx] = s.values[j];
      }
      let name = r.series.length === 1 ? e.label : s.name;
      const parts = [];
      if (showMetric) parts.push(metricLabel(e.metric));
      if (showType) parts.push(typeLabel(e.type));
      if (parts.length) name += ' \u00b7 ' + parts.join(' \u00b7 ');
      allSeries.push({ name, values });
    }
  }

  // Chart title: show shared dimensions, omit mixed ones
  let title = '';
  if (!showMetric && !showType) {
    title = metricLabel([...metrics][0]) + ' \u2014 ' + typeLabel([...types][0]);
  } else if (showMetric && !showType) {
    title = typeLabel([...types][0]);
  } else if (!showMetric && showType) {
    title = metricLabel([...metrics][0]);
  }

  const option = {
    color: palette,
    title: {
      text: title, left: 'center', top: 8,
      textStyle: {
        fontSize: 14, fontWeight: 600, color: '#1c1917',
        fontFamily: '-apple-system, BlinkMacSystemFont, system-ui, sans-serif'
      }
    },
    tooltip: {
      trigger: 'axis', confine: true,
      backgroundColor: '#fff',
      borderColor: '#e7e5e4',
      borderWidth: 1,
      textStyle: {
        fontSize: 12, color: '#1c1917',
        fontFamily: '-apple-system, BlinkMacSystemFont, system-ui, sans-serif'
      },
      extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 6px;',
    },
    legend: {
      type: 'scroll', bottom: 0,
      textStyle: {
        fontSize: 11, color: '#57534e',
        fontFamily: '-apple-system, BlinkMacSystemFont, system-ui, sans-serif'
      },
      pageIconColor: '#78716c',
      pageIconInactiveColor: '#d6d3d1',
      pageTextStyle: { color: '#78716c' },
      itemWidth: 16, itemHeight: 2,
      itemGap: 16,
    },
    grid: { left: 72, right: 32, top: 48, bottom: 80 },
    xAxis: {
      type: 'category', data: mergedDates,
      axisLabel: { rotate: 45, fontSize: 10, color: '#78716c',
        fontFamily: '-apple-system, BlinkMacSystemFont, system-ui, sans-serif' },
      axisLine: { lineStyle: { color: '#e7e5e4' } },
      axisTick: { lineStyle: { color: '#e7e5e4' } },
    },
    yAxis: {
      type: 'value',
      axisLabel: { formatter: v => v.toLocaleString(), fontSize: 10, color: '#78716c',
        fontFamily: '-apple-system, BlinkMacSystemFont, system-ui, sans-serif' },
      axisLine: { show: false },
      axisTick: { show: false },
      splitLine: { lineStyle: { color: '#f5f5f4' } },
    },
    dataZoom: [{ type: 'inside' }],
    series: allSeries.map(s => ({
      name: s.name, type: 'line', data: s.values,
      smooth: false, symbol: 'circle', symbolSize: 3,
      lineStyle: { width: 1.5 },
      emphasis: { focus: 'series', lineStyle: { width: 2.5 } },
      connectNulls: false,
    })),
  };

  lastRenderData = { dates: mergedDates, series: allSeries };
  chart.setOption(option, true);
  updateURL();
}

function metricLabel(m) {
  if (!meta) return m;
  const found = meta.metrics.find(x => x.value === m);
  return found ? found.label : m;
}
function typeLabel(t) {
  if (!meta) return t;
  const found = meta.types.find(x => x.value === t);
  return found ? found.label : t;
}

function renderTable() {
  if (!lastRenderData || lastRenderData.series.length === 0) {
    tableWrap.innerHTML = '<p style="color:var(--gray-400);font-size:var(--text-sm);">No data to display. Add entities and they will appear here.</p>';
    return;
  }
  const { dates, series } = lastRenderData;
  let html = '<table class="data-table"><thead><tr><th>Date</th>';
  for (const s of series) html += '<th>' + escapeHTML(s.name) + '</th>';
  html += '</tr></thead><tbody>';
  for (let i = 0; i < dates.length; i++) {
    html += '<tr><td>' + escapeHTML(dates[i]) + '</td>';
    for (const s of series) {
      const v = s.values[i];
      html += '<td>' + (v != null ? v.toLocaleString() : '') + '</td>';
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  tableWrap.innerHTML = html;
}

function escapeHTML(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function downloadCSV() {
  if (!lastRenderData || lastRenderData.series.length === 0) return;
  const { dates, series } = lastRenderData;
  const rows = [];
  const header = ['Date'].concat(series.map(s => s.name));
  rows.push(header.map(csvCell).join(','));
  for (let i = 0; i < dates.length; i++) {
    const row = [dates[i]];
    for (const s of series) row.push(s.values[i] != null ? s.values[i] : '');
    rows.push(row.map(csvCell).join(','));
  }
  const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'municipal-court-stats.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function csvCell(v) {
  const s = String(v);
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return '"' + s.replace(/"/g, '""') + '"';
  }
  return s;
}

async function init() {
  const resp = await fetch('/api/metadata');
  meta = await resp.json();

  populateSelect(selMetric, meta.metrics);
  populateSelect(selType, meta.types);
  updateAdderVisibility();

  selAddLevel.addEventListener('change', updateAdderVisibility);
  selAddCounty.addEventListener('change', () => {
    if (selAddLevel.value === 'municipality') updateAddMunicipalities();
  });
  addBtn.addEventListener('click', handleAdd);

  downloadBtn.addEventListener('click', () => {
    const url = chart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#fff' });
    const a = document.createElement('a');
    a.href = url;
    a.download = 'municipal-court-stats.png';
    a.click();
  });

  tableBtn.addEventListener('click', () => { renderTable(); tableModal.classList.add('open'); });
  tableModalClose.addEventListener('click', () => tableModal.classList.remove('open'));
  tableModal.addEventListener('click', (ev) => {
    if (ev.target === tableModal) tableModal.classList.remove('open');
  });
  csvBtn.addEventListener('click', downloadCSV);

  infoBtn.addEventListener('click', () => infoModal.classList.add('open'));
  modalClose.addEventListener('click', () => infoModal.classList.remove('open'));
  infoModal.addEventListener('click', (ev) => {
    if (ev.target === infoModal) infoModal.classList.remove('open');
  });

  loadFromURL();
}

init();
</script>
</body>
</html>
